# Chapter 3 Class 1 定点数运算及其运算部件

## 原码加减

加法:

1. 同号求和, 异号求差
2. 最高位产生进位则溢出
3. 和的符号同**被加数/被减数**

减法:

1. 同号求差, 异号求和
2. **被加数/被减数**加上**加数/减数**的**补码**
   - 最高位产生进位, 说明结果正确, 结果符号同**被加数/被减数**
   - 没有进位, 得到的是结果的**补码**, 需要还原成绝对值, 结果符号与**被加数/被减数**相反

## 原码乘法

计算$X\times Y=X\times(0.Y_{0}Y_{1}...Y_{n})$

理论依据:

$$
P_{1}=2^{-1}(P_{0}+X\cdot Y_{n})\\
P_{2}=2^{-1}(P_{1}+X\cdot Y_{n-1})\\
P_{3}=2^{-1}(P_{2}+X\cdot Y_{n-2})\\
...\\
P_{n}=2^{-1}(P_{n-1}+X\cdot Y_{0})\\
$$

计算过程：根据$Y_{i}$是$1$还是$0$, 决定是否将$X$加到$P_{i}$, 然后移位，符号位通过异或得到

二位乘法(一次计算 2 位)

- 考虑$Y_{i-1}Y_{i}$
- $case\space 00: P_{i+1}=2^{-2}(P_{i}+0)$
- $case\space 01: P_{i+1}=2^{-2}(P_{i}+X)$
- $case\space 10: P_{i+1}=2^{-2}(P_{i}+2X)$
- $case\space 11: P_{i+1}=2^{-2}(P_{i}-X)+X$ (前一次$-X$, 移位后$+X$)

## 补码乘法

计算$[X]_{补}=x_{n-1}x_{n-2}...x_{1}x_{0}, [Y]_{补}=y_{n-1}y_{n-2}...y_{1}y_{0}$

理论依据:

$$
P_{1}=2^{-1}(P_{0}+(y_{0}-y_{1})X)\\
P_{2}=2^{-1}(P_{1}+(y_{1}-y_{2})X)\\
P_{3}=2^{-1}(P_{2}+(y_{2}-y_{3})X)\\
...\\
P_{n}=2^{-1}(P_{n-1}+(y_{n-1}-y_{n})X)\\
$$

根据$y_{i-1}-y_{i}$的值, 决定是否将$X$加或减到$P_{i}$, 然后移位

二位乘法(一次计算 2 位)

- 考虑$y_{i+1}y_{i}y_{i-1}$
- $case\space 000: 0$
- $case\space 001: +[X]_{补}$
- $case\space 010: +[X]_{补}$
- $case\space 011: +2[X]_{补}$
- $case\space 100: +2[-X]_{补}$
- $case\space 101: +[-X]_{补}$
- $case\space 110: +[-X]_{补}$
- $case\space 111: 0$

## 乘法溢出判定

- 有符号:若$P_{sh}$每位都等于$P_{s}$的最高位，则不溢出
- 无符号:若$P_{uh}=0$，则不溢出

## 定点除法

### 预处理

1. 若**被除数 =0**且**除数 ≠0**，或定点整数除法时|被除数|<|除数|，则商为`0`，不再继续
2. 若**被除数 ≠0**且**除数 =0**，则发生`“除数为0”异常`(浮点数时为`∞`或`NaN`)

只有当被除数和除数都 ≠ 0，且商 ≠ 0 时，才进一步进行除法运算。

### 无符号除法

- 与手算一样，通过被除数（中间余数）减除数来得到每一位商，`够减上商1；不够减上商0`（从 msb→lsb 得到各位商）
- 基本操作为减（加）法和移位
- 两个 n 位数相除的情况：
  - 定点正整数（即无符号数）相除：在被除数的**高位**添 n 个 0
  - 定点正小数（即原码小数）相除：在被除数的**低位**添 n 个 0
  - 这样，就将所有情况都统一为：**一个 2n 位数除以一个 n 位数**
- 第一次试商为 1 时，商有 n+1 位数，因而**溢出**，但在浮点数运算中，第一次得到的商“1”要保留

#### 恢复余数法

1. 除数装入**除数寄存器 Y**，被除数装入**余数寄存器 R**和**余数/商寄存器 Q**
2. **R**和**Q**同步串行左移一位
3. **R=R-Y**，若**R<0**，商 0，并且**R=R+Y**；否则商 1
4. 重复第(2)和第(3)步，直到取得 n 位商为止
5. **Q**左移一位，余数在**R**中，商在**Q**中

#### 加减交替法

1. 除数装入**除数寄存器 Y**，被除数装入**余数寄存器 R**和**余数/商寄存器 Q**
2. **R**和**Q**同步串行左移一位
3. 根据**前一次的商**决定运算，算完若**R<0**，商 0；否则商 1
   - 若前一次商 0，**R=R+Y**
   - 若前一次商 1，**R=R-Y**，初始为此选项
4. 重复第(2)和第(3)步，直到取得 n 位商为止
5. 若最后一次商 0，**R=R+Y**
6. **Q**左移一位，余数在**R**中，商在**Q**中

### 有符号除法

- 原码
  - 商符和商值分开处理
    - 商的数值部分由无符号数除法求得
    - 商符由被除数和除数的符号确定：同号为 0，异号为１
  - **余数的符号同被除数的符号**
- 补码
  - 方法 1：同原码除法一样，先**转换为正数**，先用无符号数除法，然后修正商和余数。
  - 方法 2：直接用**补码除法**，符号和数值一起进行运算，商符直接在运算中产生。

#### 补码恢复余数法

1. 除数装入**除数寄存器 Y**，被除数经**符号扩展**后装入**余数寄存器 R**和**余数/商寄存器 Q**
2. **R**和**Q**同步串行左移一位
3. 若**R**与**Y**同号，则**R=R–Y**；否则**R=R+Y**，并按以下规则确定商值$q_{0}$：
   - 若中间余数**R=0**或**R**操作前后**符号未变**，表示够减，则$q_{0}$置 1，转下一步
   - 若操作前后 R 的**符号已变**，表示不够减，则$q_{0}$置 0，**恢复 R 值**后转下一步
4. 重复第(2)和第(3)步，直到取得 n 位商为止
5. 若被除数与除数同号，则**Q**中就是真正的商；否则，将**Q**求补后是真正的商
6. 余数在**R**中

#### 补码不恢复余数法

1. 除数装入**除数寄存器 Y**，被除数经**符号扩展**后装入**余数寄存器 R**和**余数/商寄存器 Q**
2. 根据以下规则求第一位商$q_{n}$：
   - 若**被除数 X**与**Y**同号，则$R_{1}=X-Y$；否则$R_{1}=X+Y$，并按以下规则确定商$q_{n}$：
     - 若新的中间余数$R_{1}$与**Y**同号，则$q_{n}$置 1，转下一步
     - 若新的中间余数$R_{1}$与**Y**异号，则$q_{n}$置 0，转下一步
3. 对于**i=1 到 n**，按以下规则求出 n 位商：
   - 若$R_{i}$与**Y**同号，则$q_{n-i}$置 1，$R_{i+1}=2R_{i}+[-Y]_{补}$，**i=i+1**
   - 若$R_{i}$与**Y**异号，则$q_{n-i}$置 0，$R_{i+1}=2R_{i}+[Y]_{补}$，**i=i+1**
4. **商的修正**：最后一次**Q 寄存器**左移一位，将最高位$q_{n}$移出，最低位置上商$q_{0}$。若**被除数**与**除数**同号， **Q**中就是真正的商；否则，将**Q**中商的末位加 1
5. **余数的修正**：若**余数符号**同**被除数**符号，则不需修正，余数在**R**中；否则，按下列规则进行修正：当**被除数**和**除数**符号相同时，最后**余数加除数**；否则，最后**余数减除数**

### 变量与常数之间的除法

- 无符号数、带符号正整数：移出的低位直接丢弃
- 带符号负整数：加偏移量$2^{k}-1$，然后再右移$k$位，低位截断，$k$是右移位数

# Chapter 3 Class 2 浮点数运算及其运算部件

两个规格化浮点数分别为$A=M_{a}\cdot 2^{E_{a}}$, $B=M_{b}\cdot 2^{E_{b}}$,则：

- $A\pm B=(M_{a}\pm M_{b}\cdot 2^{-(E_{a}-E_{b})})\cdot 2^{E_{a}}$(假设$E_{a}\ge E_{b}$)
- $A*B =(M_{a} * M_{b})\cdot 2^{E_{a}+E_{b}}$
- $A/B =(M_{a} / M_{b})\cdot 2^{E_{a}-E_{b}}$

中间结果须在右边加**2 个附加位**（guard & round）

- Guard (保护位)：在 significand 右边的位
- Round (舍入位)：在保护位右边的位

## 浮点加减法

### 对阶

原则: 小阶转化成大阶

$E_{小}\leftarrow E_{大},M_{小}\leftarrow M_{小}\times 2^{E_{小}-E_{大}},E_{结果}\leftarrow E_{大}$

计算阶码大小关系$(E_{x}-E_{y})$时:

1. 对$[E_{y}]_{移}$求补
2. $[[E_{y}]_{移}]_{补}$与$[E_{x}]_{移}$相加
3. 得到$[\Delta E]_{补}$
4. 根据$[\Delta E]_{补}$的符号位判断

### 尾数加减

尾数右移时, 还原隐去的 1, 不要丢弃低位

### 尾数规格化

- **当尾数高位为 0**，则需左规：尾数左移一次，阶码减 1，直到 MSB 为 1 或阶码为 00000000（-126，非规格化数），每次阶码减 1 后要判断阶码是否下溢（比最小可表示的阶码还要小）
- **当尾数最高位有进位**，需右规：尾数右移一次，阶码加 1，直到 MSB 为 1，每次阶码加 1 后要判断阶码是否上溢（比最大可表示的阶码还要大）
- 阶码溢出异常处理：阶码上溢，则结果溢出；阶码下溢到无法用非规格化数表示，则结果为 0

### 尾数舍入

就近舍入：舍入为最近可表示的数

- 非中间值：0 舍 1 入
- 中间值：强迫结果为**偶数**

### 溢出判断

- 左规（阶码-1）时，先判断阶码是否为全 0
  - 若是，则直接置阶码下溢
  - 否则，阶码减 1 后判断阶码是否为全 0，若是，则阶码下溢
- 右规（阶码+1）时，先判断阶码是否为全 1
  - 若是，则直接置阶码上溢
  - 否则，阶码加 1 后判断阶码是否为全 1，若是，则阶码上溢

## 浮点乘除法

### 求阶

$X_e \pm Y_e \mp 127$

### 尾数乘除

定点数乘除：$X_m */ Y_m$

### 计算符号位

两数符号相同，结果为正；两数符号相异，结果为负

### 尾数规格化

- **当尾数高位为 0**，则需左规：尾数左移一次，阶码减 1，直到 MSB 为 1 或阶码为 00000000（-126，非规格化数），每次阶码减 1 后要判断阶码是否下溢（比最小可表示的阶码还要小）
- **当尾数最高位有进位**，需右规：尾数右移一次，阶码加 1，直到 MSB 为 1，每次阶码加 1 后要判断阶码是否上溢（比最大可表示的阶码还要大）
- 阶码溢出异常处理：阶码上溢，则结果溢出；阶码下溢到无法用非规格化数表示，则结果为 0

### 尾数舍入

就近舍入：舍入为最近可表示的数

- 非中间值：0 舍 1 入
- 中间值：强迫结果为**偶数**

### 溢出判断

- 左规（阶码-1）时，先判断阶码是否为全 0
  - 若是，则直接置阶码下溢
  - 否则，阶码减 1 后判断阶码是否为全 0，若是，则阶码下溢
- 右规（阶码+1）时，先判断阶码是否为全 1
  - 若是，则直接置阶码上溢
  - 否则，阶码加 1 后判断阶码是否为全 1，若是，则阶码上溢
