# 网络层

## Internet 的工作方式

在链路层提供的服务基础上通过**多跳传输**将数据递交到最终目的地

路由器的

- **数据平面**: 负责转发数据包
- **控制平面**: 维护路由表, 选择最佳路径

### 两种工作方式

- **虚电路**: 在通信前建立一条虚电路, 通信结束后释放
  - 分为**连接建立**, **数据传输**, **连接释放**三个阶段
  - 仅仅在最开始进行一次**路由选择**
- **数据报**: 无需建立连接, 传输时决定路由

### 虚电路

- 一条虚电路途中经过多个中间节点, 每个节点需要维护虚电路上的**上一节点**和**下一节点**信息
- 每个链路上可能会有多条虚电路通过, 要能够区分收到的分组属于**哪个虚电路**, 要转发给哪个下一跳节点

为了区分虚电路, 需要在引入**虚电路号**, 虚电路号的确定有两种方式

- **全局唯一**: 节点之间需要维护一个**全局的虚电路号表**, 开销大
- **链路唯一**: 每条链路上的虚电路号都是唯一的, 用于确定下一跳
  - 建立和释放虚电路的协议称为**信令协议**
  - **交换虚电路(SCV)**: 由交换机之间的信令协议建立的虚电路
  - **永久虚电路(PVC)**: 由网络管理员配置的虚电路

对于一条虚电路, 每个节点需要维护:

- **前一节点**
- **到来链路**的虚电路号
- **下一节点**
- **出去链路**的虚电路号

当某个节点收到分组时, 查找虚电路表, 确定下一跳节点和虚电路号, 将分组的**到来链路**的虚电路号替换为**出去链路**的虚电路号, 转发给下一跳节点, 称之为**标签交换(MPLS)**

### 数据报和虚电路

|                    | 数据报                                             | 虚电路                                   |
| ------------------ | -------------------------------------------------- | ---------------------------------------- |
| 路由选择           | 每个分组独立选择路由                               | 仅在连接建立时选择路由                   |
| 延时               | 分组传输延时                                       | 建立连接的延时 + 分组传输延时            |
| **节点失败影响**   | 除了崩溃时正由该节点转发的分组外, 其他分组不受影响 | 该节点崩溃时, 该节点上的所有虚电路都失效 |
| 拥塞控制和服务质量 | 难, 可能失序                                       | 可进行准入控制, 可进行差错和流量控制     |
| 地址(头部)开销     | 每个分组包含源端和目的端地址                       | 每个分组包含虚电路号                     |
| **状态信息**       | 无                                                 | 需要维护虚电路表                         |

## 互联网的路由方式

### 逐跳路由

每个路由器只知道**下一跳**的地址

- 可能短暂出现环路
- **单播路由**: 下一跳节点只有一个
- **多播路由**: 下一跳节点有多个

### 源路由

**发送者**决定途中需要经过的节点, 记录在分组的**首部**中

- 可以通过第三方获得网络拓扑信息, 决定路径
- 可以通过扩散等动态发现协议发现路径
- 首部长度限制了路径长度
- 适用**流量工程**, 可以根据网络拓扑信息选择最优路径
- **严格源路由**: 路径中的每个节点都必须是指定的节点
- **松散源路由**: 允许通过不在列表中的节点

## IP 协议

**IP**只要求下层物理网络提供**基本的数据递交功能**以及**MTU**一般不低于 576 字节, 提供**不可靠无连接**方式的数据递交服务:

- **单播**: 一到一
- **组播/多播**: 一到多或者多到多
- **广播**: 一到所有
- **联播/任播**: 一到多中任意一个

IP 协议**分组格式**的设计考虑到:

- 无连接方式, 提供转发支持: **源地址**和**目的地址**
- 多个高层协议: **协议号**(ICMP 0x01, TCP 0x06, UDP 0x11)
- 路由回路: **生命期 TTL**字段, 每经过一个节点转发时, TTL 减 1, 为 0 时丢弃, 通过 ICMP 协议发送通知给发送者, 目的地收到 TTL=0 的分组不会丢弃
- 分组出错: **头部检验和**字段, 每跳都要重新计算
- MTU 限制: 分段和重组
- 扩展性: 支持 IP 选项, 固定+可选+数据, 通过头部长度确定可选部分. 总长度和头部长度确定数据部分的长度
- 服务质量: 服务类型(ToS)字段, 早期忽略, 后为区分服务码字 DSCP 和拥塞通知相关字段

IP 分组的格式如下:

![IP分组格式](./img/4.png)

IP 分组的总长度, 包括头部和数据部分, 最大 65535 字节

- **头部长度**: 占 4 位, 以 4 字节为单位, 最大 4\*15=60 字节
- **IP 选项**: 长度可变, 最大 40 字节
- **填充**: 用于保证头部长度按 4 字节对齐
- **生命期(TTL)**: 8 位, 最大 255
- **头部检验和**: 采用 Internet 检验和算法
  - 16-bit word 反码加法求和后取反码
  - 检验: 反码加法后验证是否为全 1
  - 途中路由器转发时 TTL 减 1, 需要重新计算检验和
- **服务类型(Type of Service)**: 早期忽略, 一般为 0
  - 前面 6 个比特用于区分服务, 属于哪个负载类
  - 后面 2 个比特用于 ECN

### IP 选项

![IP选项](./img/5.png)

- **单字节选项**: 仅仅包含选项类型
  - type = 0: 选项结束
  - type = 1: 选项之间填充
- **多字节选项**: 采用 TLV 方式
  - type 的第一个 bit 称为**copied**, 为 1 时表示该选项需要复制到分段中的每个分段
- 记录路由(RR)选项: 用于记录分组经过的路由器的 IP 地址
  - 指针给出目前尚未使用的第一个 IP 地址槽的偏移, 初始为 4
- 源路由选项: 用于指定分组的路由
  - 严格源路由(type = 9), 松散源路由(type = 3)
- 时间戳选项: 用于记录分组经过的路由器的时间戳

### 分段和重组

IP 分组的总长度, 包括头部和数据部分, 最大 65535 字节, 但是分组传输经过的物理网络都有**MTU**, 一般不低于 576 字节, 超过 MTU 的分组需要分段

- 逐条重组: 可能发生多次分段和重组
- 接收方重组: 途中可以分段, 接收方重组

IP 采用了**接收方重组**的方式, 接收方要求可以处理长度至少为 576 字节的分段

端和目的端之间会发送多个 IP 分组, 为了区分分段属于哪个分组, 需要引入**分段标识**用于标识原始分组, 以及**分段偏移**(13-bit)用于标识分段在原始分组中的位置, 以 8 字节为单位

标志位**MF**用于标识后面是否还有分段, 收到 MF=0 的分段, 且之前所有的分段都已到来, 可以重组, 重组计时器超时时丢弃所有的分段

标志位**DF**用于标识是否允许分段, 为 1 时不允许分段, 为 0 时允许分段

### MAC 地址

一个局域网中有多个节点, 节点通过网卡连接到局域网, **媒体访问控制**(MAC)机制保证每个网卡都有唯一的 MAC 地址, 用于标识节点, 在帧头部中包含源 MAC 地址和目的 MAC 地址

为了保证任意两块网卡在一个局域网中唯一的 MAC 地址, 每个网卡有一个在世界上唯一的 MAC 地址, MAC 地址用于标识某个网卡, 并不需要描述是哪个局域网上的网卡, 采用**平坦地址空间**

MAC 地址为**6 个字节**, 前面**24 个位**分配给某个厂商或机构, 后面**24 个位**由厂商或机构自行分配

第 1 个字节的最低两位(LSB)有特殊含义:

- 最低位为 I/G(Individual/Group), 为 0 时表示单播地址, 为 1 时表示组播地址
- 次低位为 U/L(Universal/Local), 为 0 时为全局地址, 为 1 时是本地管理地址

局域网(以太网)支持三种数据传输模式:

- 单播: 发送帧给指定的接收者
- 广播: 发送帧给链路上的所有接收者, 广播帧的目的地址为全 1, 即 FF-FF-FF-FF-FF-FF
- 组播: 发送帧给链路上的某些接收者, 组播地址中的第一个字节的最低位为 1

节点(网卡)从链路上收到一个单播帧之后, 进行**过滤**, 如果帧的目的地址和节点的 MAC 地址匹配, 则其递交给高层, 否则丢弃该帧; 网卡可设置为混杂模式: 所有收到的帧都交给高层

收到广播帧时接收并递交给高层

收到组播帧时:

- 网卡想要接收某些组播帧, 必须通知网卡对哪些组播地址感兴趣
- 网卡维护少数几个感兴趣的**组播地址列表**
- 网卡还可纪录多个感兴趣的**组播地址的散列值**
- 首先将帧中的目的组播地址与感兴趣的组播地址列表匹配；如果不匹配时, 计算目的组播地址的散列值, 然后与保存的散列值比较, 如果匹配, 则接收并递交给高层

### IP 地址

每个节点(主机和路由器)的网络接口(网卡)都有一个 IP 地址: **ID + Locator**

IP 地址分为**网络号**和**主机号**, 网络号标识某个"物理"网络, 主机号标识该网络中的主机, 路由时只需了解如何到达接口所在的(物理)网络, 而不必了解该网络的每一台主机, 第二层物理网络可以直接递交给其所在物理网络中的其他节点

为了将 IP 地址映射为物理地址, 需要引入**地址解析协议**(ARP), 通过**ARP 请求**和**ARP 应答**实现

目前的 Internet(采用 IPv4 协议)使用的 IP 地址为**32 比特的整数**, 总共$2^{32}$个地址, 采用点十进制方法描述: 每个字节转换为十进制数字, 中间以.隔开

#### IP 地址分类

IP 地址分为**A 类**, **B 类**, **C 类**, **D 类**, **E 类**五类

![IP地址分类](./img/6.png)

- **A 类**: 1/2 地址空间, 网络号全 0 和全 1 有特殊含义, 支持$2^{24}-2$个主机
- **B 类**: 1/4 地址空间, 支持$2^{14}$个网络, 每个网络支持$2^{16}-2$个主机
- **C 类**: 1/8 地址空间, 支持$2^{21}$个网络, 每个网络支持$2^{8}-2=254$个主机

##### 特殊地址

- 主机部分:
  - 全 0: 表示本网络
  - 全 1: 表示本网络上的所有主机, 可作为广播地址
- 网络部分和主机部分:
  - 全 1: `255.255.255.255`, 表示接口上的所有主机, 可作为广播地址
  - 全 0: `0.0.0.0`, 表示未知地址
- 网络部分:
  - 全 0: 表示未知网络
- `127.0.0.0`为**环回地址**, 用于本机测试, 任何分组发送到环回地址都会被本机接收

#### 子网
